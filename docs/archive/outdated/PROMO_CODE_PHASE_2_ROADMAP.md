# Promo Code System - Phase 2 Implementation Roadmap

**Date**: 2025-10-18  
**Status**: üöÄ **READY TO START**  
**Phase**: Phase 2 - Backend Integration

---

## üìä Phase Overview

### Phase 1 Completion ‚úÖ

- ‚úÖ All frontend components built
- ‚úÖ Mock data and service layer ready
- ‚úÖ User flows tested manually
- ‚úÖ Design 100% aligned with specs
- ‚úÖ Navigation working correctly

### Phase 2 Goals üéØ

- Build backend data models
- Create API endpoints
- Integrate Stripe webhook for bundle code generation
- Replace frontend mocks with real API calls
- Build admin management tools
- Complete testing

### Phase 3 Preview üëÄ

- Enhanced admin features
- Analytics and reporting
- Email notifications
- Advanced code management

---

## üó∫Ô∏è Implementation Roadmap

### Week 1: Backend Foundation (Todos #12-15)

#### Todo #12: Create PromoCode Model ‚è±Ô∏è 2-3 hours

**Priority**: üî¥ Critical - Foundation for everything else

**File**: `backend/src/models/PromoCode.ts`

**Schema Design**:

```typescript
interface IPromoCode {
  // Core fields
  code: string; // "X8K9P2L4" - unique, indexed
  type: "bundle_discount" | "staff_access";

  // Discount configuration
  discountAmount?: number; // For bundle: $50 = 50
  discountPercent?: number; // For staff: 100 (100% off)

  // Ownership & restrictions
  ownerId: ObjectId; // User who owns this code
  allowedProgramIds?: ObjectId[]; // For staff: specific programs, [] = all
  excludedProgramId?: ObjectId; // For bundle: can't use on purchase program

  // Status tracking
  isActive: boolean; // Can be used?
  isUsed: boolean; // Already redeemed?
  expiresAt?: Date; // When it expires (optional)

  // Usage tracking
  usedAt?: Date; // When it was used
  usedForProgramId?: ObjectId; // Which program it was used for

  // Metadata
  createdAt: Date;
  createdBy: string; // "system" or admin user ID
}
```

**Indexes**:

- `code` (unique)
- `ownerId` + `isActive` + `isUsed` (compound for fast user queries)
- `type` + `isActive`
- `expiresAt` (for cleanup jobs)

**Validation**:

- `code`: 8 characters, uppercase alphanumeric
- `discountAmount`: 1-500 (dollars)
- `discountPercent`: 0-100
- One of `discountAmount` or `discountPercent` required
- `allowedProgramIds`: only for staff_access type

**Export**: Add to `backend/src/models/index.ts`

---

#### Todo #13: Update Purchase Model ‚è±Ô∏è 1-2 hours

**Priority**: üî¥ Critical - Required for checkout flow

**File**: `backend/src/models/Purchase.ts`

**Add Fields to IPurchase**:

```typescript
// Promo code used on THIS purchase
promoCode?: string;              // Code that was applied (e.g., "X8K9P2L4")
promoDiscountAmount?: number;    // Dollar discount from promo
promoDiscountPercent?: number;   // Percentage discount (for 100% staff codes)

// Bundle code generated BY this purchase
bundlePromoCode?: string;        // Auto-generated code user receives
bundleDiscountAmount?: number;   // Amount for bundle code (e.g., 50 for $50 off)
bundleExpiresAt?: Date;          // When bundle code expires
```

**Update Schema**:

- All optional fields (not all purchases use promo codes)
- No indexes needed (rare queries)
- Update TypeScript interface and Mongoose schema

**Migration**: Existing purchases won't have these fields (that's fine - optional)

---

#### Todo #14: Enhance createCheckoutSession API ‚è±Ô∏è 4-6 hours

**Priority**: üî¥ Critical - Core checkout enhancement

**File**: `backend/src/controllers/purchaseController.ts`

**Request Body Change**:

```typescript
interface CreateCheckoutRequest {
  programId: string;
  isClassRep: boolean;
  promoCode?: string; // ‚Üê NEW optional field
}
```

**New Validation Logic**:

```typescript
if (promoCode) {
  // 1. Find code in database
  const code = await PromoCode.findOne({ code: promoCode });
  if (!code) throw new Error("Invalid promo code");

  // 2. Check active and not used
  if (!code.isActive) throw new Error("Promo code is no longer active");
  if (code.isUsed) throw new Error("Promo code has already been used");

  // 3. Check expiration
  if (code.expiresAt && code.expiresAt < new Date()) {
    throw new Error("Promo code has expired");
  }

  // 4. Check ownership
  if (code.ownerId.toString() !== userId.toString()) {
    throw new Error("This promo code does not belong to you");
  }

  // 5. Bundle-specific: check excluded program
  if (code.type === "bundle_discount" && code.excludedProgramId) {
    if (code.excludedProgramId.toString() === programId) {
      throw new Error(
        "Cannot use bundle code on the program that generated it"
      );
    }
  }

  // 6. Staff-specific: check allowed programs
  if (code.type === "staff_access" && code.allowedProgramIds?.length > 0) {
    if (!code.allowedProgramIds.some((id) => id.toString() === programId)) {
      throw new Error("This code is not valid for this program");
    }
  }
}
```

**Price Calculation Enhancement**:

```typescript
// Existing calculation
let finalPrice = fullPrice - classRepDiscount - earlyBirdDiscount;

// NEW: Apply promo discount
let promoDiscountAmount = 0;
let promoDiscountPercent = 0;

if (promoCode) {
  if (code.type === "bundle_discount") {
    promoDiscountAmount = code.discountAmount || 0;
    finalPrice -= promoDiscountAmount;
  } else if (code.type === "staff_access") {
    promoDiscountPercent = code.discountPercent || 100;
    finalPrice = 0; // 100% off
  }
}

finalPrice = Math.max(0, finalPrice); // Never negative
```

**Special Case: 100% Off (Free Purchase)**:

```typescript
if (finalPrice === 0) {
  // Skip Stripe entirely for free purchases

  // 1. Create completed purchase immediately
  const purchase = await Purchase.create({
    userId,
    programId,
    orderNumber: generateOrderNumber(),
    fullPrice,
    classRepDiscount,
    earlyBirdDiscount,
    promoCode: code.code,
    promoDiscountPercent,
    finalPrice: 0,
    isClassRep,
    isEarlyBird,
    status: "completed",
    purchaseDate: new Date(),
    billingInfo: {
      /* user data */
    },
    paymentMethod: { type: "promo_code" }, // Special type
  });

  // 2. Mark promo code as used
  await PromoCode.findByIdAndUpdate(code._id, {
    isUsed: true,
    usedAt: new Date(),
    usedForProgramId: programId,
  });

  // 3. Return success (no Stripe redirect)
  return res.json({
    success: true,
    message: "Free access granted via promo code",
    purchase: {
      id: purchase._id,
      orderNumber: purchase.orderNumber,
    },
  });
}
```

**Paid Purchase Flow** (finalPrice > 0):

- Store promo code info in purchase record
- Pass to Stripe metadata
- Normal Stripe checkout flow
- Code will be marked as used in webhook

---

#### Todo #15: Enhance Stripe Webhook - Bundle Code Generation ‚è±Ô∏è 4-5 hours

**Priority**: üî¥ Critical - Auto-generates user rewards

**File**: `backend/src/controllers/webhookController.ts`

**Enhancement Location**: After marking purchase as "completed" in `checkout.session.completed` handler

**Bundle Code Generation Logic**:

```typescript
// After: purchase.status = "completed"; await purchase.save();

// Check if bundle discount feature is enabled
const bundleConfig = await SystemConfig.findOne({ key: "bundle_discount" });
const bundleEnabled = bundleConfig?.enabled ?? true;
const bundleAmount = bundleConfig?.discountAmount ?? 50; // Default $50
const expiryDays = bundleConfig?.expiryDays ?? 30; // Default 30 days

if (bundleEnabled && purchase.finalPrice > 0) {
  // Only generate bundle codes for paid purchases

  // 1. Generate unique code
  const bundleCode = await generateUniquePromoCode(); // Helper function

  // 2. Calculate expiry date
  const expiresAt = new Date();
  expiresAt.setDate(expiresAt.getDate() + expiryDays);

  // 3. Create PromoCode document
  const promoCode = await PromoCode.create({
    code: bundleCode,
    type: "bundle_discount",
    discountAmount: bundleAmount,
    ownerId: purchase.userId,
    excludedProgramId: purchase.programId, // Can't use on same program
    isActive: true,
    isUsed: false,
    expiresAt,
    createdAt: new Date(),
    createdBy: "system",
  });

  // 4. Update purchase with bundle code info
  purchase.bundlePromoCode = promoCode.code;
  purchase.bundleDiscountAmount = bundleAmount;
  purchase.bundleExpiresAt = expiresAt;
  await purchase.save();

  // 5. Optional: Send email notification (Phase 3)
  // await sendBundleCodeEmail(user, promoCode);
}
```

**Helper Function** (add to utilities):

```typescript
async function generateUniquePromoCode(): Promise<string> {
  const characters = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // Exclude I, O, 0, 1
  let code: string;
  let exists = true;

  while (exists) {
    code = "";
    for (let i = 0; i < 8; i++) {
      code += characters.charAt(Math.floor(Math.random() * characters.length));
    }

    // Check if code already exists
    const existing = await PromoCode.findOne({ code });
    exists = !!existing;
  }

  return code!;
}
```

---

### Week 2: API Layer (Todos #16-18)

#### Todo #16: Create Promo Code Routes & Controller ‚è±Ô∏è 6-8 hours

**Priority**: üü° High - Enables frontend integration

**Files**:

- `backend/src/routes/promoCodeRoutes.ts`
- `backend/src/controllers/promoCodeController.ts`

**User Endpoints**:

```typescript
// GET /api/promo-codes/my-codes
// Query params: ?status=active&programId=xyz (optional)
export async function getMyPromoCodes(req, res) {
  const userId = req.user._id;
  const { status, programId } = req.query;

  const query: any = { ownerId: userId };

  // Filter by status
  if (status === "active") {
    query.isActive = true;
    query.isUsed = false;
    query.$or = [
      { expiresAt: { $exists: false } },
      { expiresAt: { $gte: new Date() } },
    ];
  } else if (status === "used") {
    query.isUsed = true;
  } else if (status === "expired") {
    query.isUsed = false;
    query.expiresAt = { $lt: new Date() };
  }

  // Populate program titles for used codes
  const codes = await PromoCode.find(query)
    .populate("usedForProgramId", "title")
    .sort({ createdAt: -1 });

  res.json({ codes });
}

// POST /api/promo-codes/validate
// Body: { code: string, programId: string }
export async function validatePromoCode(req, res) {
  const { code, programId } = req.body;
  const userId = req.user._id;

  // Find code
  const promoCode = await PromoCode.findOne({ code });

  if (!promoCode) {
    return res.json({
      valid: false,
      message: "Invalid promo code",
    });
  }

  // Validate all conditions
  if (!promoCode.isActive) {
    return res.json({ valid: false, message: "Code is no longer active" });
  }

  if (promoCode.isUsed) {
    return res.json({ valid: false, message: "Code has already been used" });
  }

  if (promoCode.expiresAt && promoCode.expiresAt < new Date()) {
    return res.json({ valid: false, message: "Code has expired" });
  }

  if (promoCode.ownerId.toString() !== userId.toString()) {
    return res.json({ valid: false, message: "Code does not belong to you" });
  }

  // Bundle-specific validation
  if (promoCode.type === "bundle_discount" && promoCode.excludedProgramId) {
    if (promoCode.excludedProgramId.toString() === programId) {
      return res.json({
        valid: false,
        message: "Cannot use on the program that generated this code",
      });
    }
  }

  // Staff-specific validation
  if (
    promoCode.type === "staff_access" &&
    promoCode.allowedProgramIds?.length > 0
  ) {
    const allowed = promoCode.allowedProgramIds.some(
      (id) => id.toString() === programId
    );
    if (!allowed) {
      return res.json({
        valid: false,
        message: "Code not valid for this program",
      });
    }
  }

  // All validations passed
  const discount =
    promoCode.type === "bundle_discount"
      ? { type: "amount", value: promoCode.discountAmount }
      : { type: "percent", value: promoCode.discountPercent };

  res.json({
    valid: true,
    discount,
    message: "Promo code is valid",
  });
}
```

**Admin Endpoints**:

```typescript
// GET /api/promo-codes (admin only)
// Query: ?type=bundle&status=active&search=X8K&page=1&limit=20
export async function getAllPromoCodes(req, res) {
  const { type, status, search, page = 1, limit = 20 } = req.query;

  const query: any = {};

  if (type) query.type = type;
  if (status === "active") query.isActive = true;
  if (status === "used") query.isUsed = true;
  if (search) query.code = { $regex: search, $options: "i" };

  const codes = await PromoCode.find(query)
    .populate("ownerId", "firstName lastName email")
    .populate("usedForProgramId", "title")
    .sort({ createdAt: -1 })
    .limit(Number(limit))
    .skip((Number(page) - 1) * Number(limit));

  const total = await PromoCode.countDocuments(query);

  res.json({
    codes,
    pagination: {
      total,
      page: Number(page),
      pages: Math.ceil(total / Number(limit)),
    },
  });
}

// POST /api/promo-codes/staff (admin only)
// Body: { userId, programIds, expiresAt }
export async function createStaffCode(req, res) {
  const { userId, programIds, expiresAt } = req.body;
  const adminId = req.user._id;

  // Validate user exists
  const user = await User.findById(userId);
  if (!user) throw new Error("User not found");

  // Generate code
  const code = await generateUniquePromoCode();

  // Create promo code
  const promoCode = await PromoCode.create({
    code,
    type: "staff_access",
    discountPercent: 100,
    ownerId: userId,
    allowedProgramIds: programIds || [], // Empty = all programs
    isActive: true,
    isUsed: false,
    expiresAt: expiresAt ? new Date(expiresAt) : undefined,
    createdAt: new Date(),
    createdBy: adminId.toString(),
  });

  // Optional: Send email to user (Phase 3)

  res.json({
    success: true,
    code: promoCode,
  });
}

// GET /api/promo-codes/config (admin only)
export async function getBundleConfig(req, res) {
  const config = await SystemConfig.findOne({ key: "bundle_discount" });

  res.json({
    enabled: config?.enabled ?? true,
    discountAmount: config?.discountAmount ?? 50,
    expiryDays: config?.expiryDays ?? 30,
  });
}

// PUT /api/promo-codes/config (admin only)
// Body: { enabled, discountAmount, expiryDays }
export async function updateBundleConfig(req, res) {
  const { enabled, discountAmount, expiryDays } = req.body;

  // Validation
  if (discountAmount < 10 || discountAmount > 200) {
    throw new Error("Discount must be between $10 and $200");
  }
  if (expiryDays < 7 || expiryDays > 365) {
    throw new Error("Expiry must be between 7 and 365 days");
  }

  const config = await SystemConfig.findOneAndUpdate(
    { key: "bundle_discount" },
    {
      key: "bundle_discount",
      enabled,
      discountAmount,
      expiryDays,
    },
    { upsert: true, new: true }
  );

  res.json({ config });
}
```

**Routes Setup**:

```typescript
// backend/src/routes/promoCodeRoutes.ts
import express from "express";
import * as controller from "../controllers/promoCodeController";
import { authenticateToken } from "../middleware/authMiddleware";
import { requireAdmin } from "../middleware/adminMiddleware";

const router = express.Router();

// User routes
router.get("/my-codes", authenticateToken, controller.getMyPromoCodes);
router.post("/validate", authenticateToken, controller.validatePromoCode);

// Admin routes
router.get("/", authenticateToken, requireAdmin, controller.getAllPromoCodes);
router.post(
  "/staff",
  authenticateToken,
  requireAdmin,
  controller.createStaffCode
);
router.get(
  "/config",
  authenticateToken,
  requireAdmin,
  controller.getBundleConfig
);
router.put(
  "/config",
  authenticateToken,
  requireAdmin,
  controller.updateBundleConfig
);

export default router;
```

**Register in server.ts**:

```typescript
import promoCodeRoutes from "./routes/promoCodeRoutes";
app.use("/api/promo-codes", promoCodeRoutes);
```

---

#### Todo #17: Create Bundle Discount Config System ‚è±Ô∏è 2-3 hours

**Priority**: üü° Medium - Used by webhook and admin UI

**File**: `backend/src/models/SystemConfig.ts` (create or extend existing)

**Schema**:

```typescript
interface ISystemConfig {
  key: string; // "bundle_discount", "email_settings", etc.
  enabled?: boolean;
  discountAmount?: number; // For bundle_discount
  expiryDays?: number; // For bundle_discount
  metadata?: any; // For future configs
}
```

**Default Config**:

```typescript
{
  key: "bundle_discount",
  enabled: true,
  discountAmount: 50,  // $50 off
  expiryDays: 30,      // 30 days to use
}
```

**Environment Variables** (add to `.env.example`):

```bash
# Bundle Discount Settings (database overrides these defaults)
BUNDLE_DISCOUNT_ENABLED=true
BUNDLE_DISCOUNT_AMOUNT=50
BUNDLE_EXPIRY_DAYS=30
```

---

#### Todo #18: Replace Mock PromoCodeService with Real API ‚è±Ô∏è 3-4 hours

**Priority**: üü° High - Connects frontend to backend

**File**: `frontend/src/services/promoCodeService.ts`

**Replace Implementation**:

```typescript
import axios from "axios";

class PromoCodeService {
  private baseUrl = "/api/promo-codes";

  async getMyPromoCodes(): Promise<PromoCode[]> {
    const response = await axios.get(`${this.baseUrl}/my-codes`);
    return response.data.codes;
  }

  async getUserAvailableCodesForProgram(
    programId: string
  ): Promise<PromoCode[]> {
    const response = await axios.get(
      `${this.baseUrl}/my-codes?status=active&programId=${programId}`
    );
    return response.data.codes;
  }

  async validatePromoCode(code: string, programId: string) {
    const response = await axios.post(`${this.baseUrl}/validate`, {
      code,
      programId,
    });
    return response.data;
  }

  async getMyPromoCodesByStatus(status: "all" | "active" | "used" | "expired") {
    const query = status !== "all" ? `?status=${status}` : "";
    const response = await axios.get(`${this.baseUrl}/my-codes${query}`);
    return response.data.codes;
  }
}

export const promoCodeService = new PromoCodeService();
```

**Test Components**:

- MyPromoCodes page
- EnrollProgram page
- PromoCodeInput component

---

### Week 3: Admin Tools (Todos #19-21)

#### Todo #19: Build Admin View All Codes Tab ‚è±Ô∏è 6-8 hours

**Priority**: üü¢ Medium - Admin visibility

**File**: `frontend/src/pages/AdminPromoCodes.tsx`

**Features**:

- Table with columns: Code, Type, Owner, Discount, Status, Expires, Actions
- Filters: type, status, search
- Pagination (20 per page)
- Copy code button
- Deactivate code button

---

#### Todo #20: Build Admin Create Staff Code Tab ‚è±Ô∏è 6-8 hours

**Priority**: üü¢ Medium - Admin tool

**Features**:

- User search/select
- Program selection (all or specific)
- Expiration date picker
- Auto-generate code
- Email notification option
- Success modal

---

#### Todo #21: Build Admin Bundle Config Tab ‚è±Ô∏è 4-6 hours

**Priority**: üü¢ Medium - System configuration

**Features**:

- Enable/disable toggle
- Amount slider ($10-$200)
- Expiry dropdown (7/30/60/90 days)
- Preview section
- Save configuration
- Load current settings

---

### Week 4: Testing & Deployment (Todos #22-25)

#### Todo #22: Backend Testing ‚è±Ô∏è 6-8 hours

**Priority**: üü° High - Quality assurance

**Coverage**:

- PromoCode model CRUD
- Validation logic
- Checkout with promo codes
- Webhook bundle generation
- All API endpoints

---

#### Todo #23: Frontend Testing ‚è±Ô∏è 4-6 hours

**Priority**: üü° High - Quality assurance

**Coverage**:

- Component rendering
- API integration
- Error handling
- User flows

---

#### Todo #24: E2E Testing ‚è±Ô∏è 4-6 hours

**Priority**: üü° High - Final validation

**Flows**:

- Complete purchase ‚Üí bundle code
- Apply bundle code ‚Üí purchase
- Admin create staff code ‚Üí user use
- Expiry and edge cases

---

#### Todo #25: Documentation & Deployment ‚è±Ô∏è 4-6 hours

**Priority**: üü° High - Production ready

**Deliverables**:

- API documentation
- Admin guide
- README updates
- Environment variables
- Staging deployment
- Production deployment

---

## üìä Time Estimates

| Week      | Todos        | Hours      | Status             |
| --------- | ------------ | ---------- | ------------------ |
| Week 1    | #12-15       | 11-16h     | Backend Foundation |
| Week 2    | #16-18       | 11-15h     | API Layer          |
| Week 3    | #19-21       | 16-22h     | Admin Tools        |
| Week 4    | #22-25       | 18-26h     | Testing & Deploy   |
| **Total** | **14 todos** | **56-79h** | **~2-3 weeks**     |

---

## üéØ Success Criteria

### Backend Complete ‚úÖ

- [ ] PromoCode model created
- [ ] Purchase model updated
- [ ] Checkout accepts promo codes
- [ ] Webhook generates bundle codes
- [ ] All API endpoints functional
- [ ] Bundle config system working

### Frontend Integration ‚úÖ

- [ ] Service replaced with real API
- [ ] All components working with backend
- [ ] Admin tools functional
- [ ] Error handling complete

### Testing ‚úÖ

- [ ] Backend tests passing
- [ ] Frontend tests passing
- [ ] E2E flows validated
- [ ] Edge cases covered

### Production Ready ‚úÖ

- [ ] Documentation complete
- [ ] Environment variables configured
- [ ] Deployed to staging
- [ ] Deployed to production

---

## üöÄ Let's Begin!

Phase 2 is well-planned and ready to execute. The roadmap provides:

- Clear task breakdown
- Time estimates
- Implementation details
- Success criteria

**Ready to start Todo #12?** Let's create the PromoCode model! üéâ
