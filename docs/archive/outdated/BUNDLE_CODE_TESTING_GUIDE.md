# Bundle Discount Code Testing Guide

**Date:** 2025-10-19  
**Status:** Active

## Overview

Bundle discount codes are **automatically generated by the Stripe webhook** after a successful purchase. They are NOT generated by the manual "Complete Purchase" button.

## ⚠️ IMPORTANT: Testing Requirements

### ✅ Correct Way to Test Bundle Codes

1. **Prerequisites:**

   - Stripe CLI must be running: `stripe listen --forward-to localhost:5001/api/webhooks/stripe`
   - Backend server running on port 5001
   - Frontend server running on port 5173
   - Bundle discount config enabled in database

2. **Test Flow:**
   ```bash
   1. Navigate to a program enrollment page
   2. Click "Proceed to Payment"
   3. Enter Stripe test card: 4242 4242 4242 4242
   4. Complete the checkout
   5. Wait for webhook to process (1-2 seconds)
   6. Payment Success page should display bundle code
   ```

### ❌ WRONG Way - Do Not Use

**Do NOT use the "Manually Complete Purchase" button!**

The manual complete button (`POST /api/purchases/:id/complete`) is for development testing only and:

- ❌ Does NOT generate bundle codes
- ❌ Does NOT trigger webhook logic
- ❌ Does NOT send confirmation emails
- ❌ Should be removed in production

---

## Bundle Code Generation Flow

### Webhook Trigger (webhookController.ts lines 202-243)

```typescript
// After purchase.save() in webhook
try {
  const bundleConfig = await SystemConfig.getBundleDiscountConfig();

  if (bundleConfig.enabled && purchase.finalPrice > 0) {
    // 1. Generate unique code (e.g., "BUNDLE3X7K2P")
    const generatedCode = await PromoCode.generateUniqueCode();

    // 2. Calculate expiry date
    const expiresAt = new Date();
    expiresAt.setDate(expiresAt.getDate() + bundleConfig.expiryDays);

    // 3. Create PromoCode document
    await PromoCode.create({
      code: generatedCode,
      type: "bundle_discount",
      discountAmount: bundleConfig.discountAmount, // From config (e.g., 5000 = $50)
      ownerId: purchase.userId,
      excludedProgramId: purchase.programId, // Can't use on same program
      isActive: true,
      isUsed: false,
      expiresAt: expiresAt,
      createdBy: "system",
    });

    // 4. Update purchase with bundle info
    purchase.bundlePromoCode = generatedCode;
    purchase.bundleDiscountAmount = bundleConfig.discountAmount;
    purchase.bundleExpiresAt = expiresAt;
    await purchase.save();
  }
} catch (bundleError) {
  console.error("Error generating bundle promo code:", bundleError);
}
```

---

## Verification Checklist

### 1. Check Bundle Config is Enabled

```bash
mongosh atcloud-signup --eval '
  const config = db.systemconfigs.findOne({ key: "bundle_discount_config" });
  printjson(config.value);
'
```

**Expected Output:**

```javascript
{
  enabled: true,
  discountAmount: 5000,  // $50 in cents
  expiryDays: 30
}
```

### 2. Check Stripe CLI is Running

```bash
ps aux | grep "stripe listen"
```

**Expected Output:**

```
stripe listen --forward-to localhost:5001/api/webhooks/stripe
```

### 3. Verify Webhook Endpoint

```bash
# In Stripe CLI output, you should see:
Ready! Your webhook signing secret is whsec_xxxxx
> payment_intent.succeeded [200]
> checkout.session.completed [200]
```

### 4. Check Purchase After Completion

```bash
mongosh atcloud-signup --eval '
  const purchase = db.purchases.findOne(
    { orderNumber: "ORD-XXXXXXX-XXXXX" },
    { bundlePromoCode: 1, bundleDiscountAmount: 1, bundleExpiresAt: 1 }
  );
  printjson(purchase);
'
```

**Expected Output:**

```javascript
{
  _id: ObjectId("..."),
  bundlePromoCode: "BUNDLE3X7K2P",
  bundleDiscountAmount: 5000,
  bundleExpiresAt: ISODate("2025-11-18T...")
}
```

### 5. Check PromoCode Document Created

```bash
mongosh atcloud-signup --eval '
  const code = db.promocodes.findOne(
    { code: "BUNDLE3X7K2P" },
    { code: 1, type: 1, discountAmount: 1, ownerId: 1, isActive: 1, isUsed: 1 }
  );
  printjson(code);
'
```

**Expected Output:**

```javascript
{
  _id: ObjectId("..."),
  code: "BUNDLE3X7K2P",
  type: "bundle_discount",
  discountAmount: 5000,
  ownerId: ObjectId("..."),
  isActive: true,
  isUsed: false
}
```

---

## Payment Success Page Display

### Frontend Code (PurchaseSuccess.tsx)

The bundle code card should display when:

1. Purchase has `bundlePromoCode` field
2. Purchase status is "completed"

```tsx
{
  purchase.bundlePromoCode && (
    <BundlePromoCodeCard
      code={purchase.bundlePromoCode}
      discountAmount={purchase.bundleDiscountAmount / 100} // Convert cents to dollars
      expiresAt={purchase.bundleExpiresAt}
    />
  );
}
```

### Expected Display

```
┌─────────────────────────────────────────────┐
│  🎉 Bonus: Exclusive Discount Code!         │
│                                             │
│  BUNDLE3X7K2P                   [Copy]      │
│                                             │
│  Use this code for $50.00 off your next    │
│  program enrollment!                        │
│                                             │
│  Valid until: November 18, 2025            │
└─────────────────────────────────────────────┘
```

---

## Troubleshooting

### Problem: Bundle code not showing on Payment Success page

**Diagnosis Steps:**

1. **Check purchase in database:**

   ```bash
   mongosh atcloud-signup --eval '
     db.purchases.findOne(
       { orderNumber: "ORD-XXXXXXX" },
       { bundlePromoCode: 1 }
     )
   '
   ```

   - If `bundlePromoCode` is missing → Webhook didn't run
   - If `bundlePromoCode` exists → Frontend issue

2. **Check Stripe CLI logs:**

   - Look for `checkout.session.completed` event
   - Status should be `[200]`
   - If `[500]` or `[400]` → Check backend logs for errors

3. **Check backend logs:**

   ```bash
   # Look for these console logs:
   "Bundle promo code BUNDLEXXXXXX generated for purchase ORD-XXXXXXX"
   ```

4. **Check bundle config:**
   ```bash
   mongosh atcloud-signup --eval '
     db.systemconfigs.findOne({ key: "bundle_discount_config" }).value
   '
   ```
   - If `enabled: false` → Enable it in Admin panel

### Problem: Webhook not firing

**Solutions:**

1. **Restart Stripe CLI:**

   ```bash
   # Kill existing process
   pkill -f "stripe listen"

   # Start new session
   stripe listen --forward-to localhost:5001/api/webhooks/stripe
   ```

2. **Check webhook secret in .env:**

   ```bash
   # Should match the secret from Stripe CLI
   STRIPE_WEBHOOK_SECRET=whsec_xxxxx
   ```

3. **Check backend is running:**
   ```bash
   curl http://localhost:5001/api/health
   ```

### Problem: Purchase completed manually

**Solution:**

Delete the manual purchase and create a new one through Stripe:

```bash
# Delete manual purchase
mongosh atcloud-signup --eval '
  db.purchases.deleteOne({ orderNumber: "ORD-XXXXXXX" });
'

# Go through proper checkout flow
# 1. Navigate to enrollment page
# 2. Use test card 4242 4242 4242 4242
# 3. Complete checkout
# 4. Wait for webhook
```

---

## Test Card Details

### Stripe Test Cards

```
Card Number:    4242 4242 4242 4242
Expiry:         Any future date (e.g., 12/25)
CVC:            Any 3 digits (e.g., 123)
ZIP:            Any 5 digits (e.g., 12345)
```

### Expected Flow

1. Enter test card details
2. Click "Pay"
3. Redirected to Payment Success page
4. Webhook processes in background (1-2 seconds)
5. Page may show "webhook processing" message briefly
6. Page refreshes automatically
7. Bundle code appears ✅

---

## Configuration Management

### Enable/Disable Bundle Codes

**Via Admin UI:**

1. Login as admin
2. Navigate to Admin → Promo Codes
3. Click "Bundle Settings" tab
4. Toggle "Enable Bundle Discount Codes"
5. Click "Save Changes"

**Via Database:**

```bash
# Enable
mongosh atcloud-signup --eval '
  db.systemconfigs.updateOne(
    { key: "bundle_discount_config" },
    { $set: { "value.enabled": true } }
  );
'

# Disable
mongosh atcloud-signup --eval '
  db.systemconfigs.updateOne(
    { key: "bundle_discount_config" },
    { $set: { "value.enabled": false } }
  );
'
```

### Change Discount Amount

```bash
# Set to $75 (7500 cents)
mongosh atcloud-signup --eval '
  db.systemconfigs.updateOne(
    { key: "bundle_discount_config" },
    { $set: { "value.discountAmount": 7500 } }
  );
'
```

### Change Expiry Days

```bash
# Set to 60 days
mongosh atcloud-signup --eval '
  db.systemconfigs.updateOne(
    { key: "bundle_discount_config" },
    { $set: { "value.expiryDays": 60 } }
  );
'
```

---

## Production Deployment Notes

### Remove Manual Complete Endpoint

**File:** `backend/src/controllers/purchaseController.ts`  
**Method:** `manuallyCompletePurchase`

This endpoint should be **removed or disabled** in production:

```typescript
// Option 1: Remove the endpoint completely
// Delete lines 1043-1117

// Option 2: Add environment check
if (process.env.NODE_ENV === "production") {
  res.status(404).json({ message: "Not found" });
  return;
}
```

### Remove Manual Complete Button

**File:** `frontend/src/pages/PurchaseSuccess.tsx`  
**Lines:** ~230-275

Remove or hide the "Manually Complete Purchase" button:

```tsx
{
  purchase.status === "pending" && process.env.NODE_ENV !== "production" && (
    <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
      {/* Manual complete button */}
    </div>
  );
}
```

---

## Summary

✅ **DO:**

- Use actual Stripe checkout flow
- Wait for webhook to process
- Check Stripe CLI is running
- Verify bundle config is enabled

❌ **DON'T:**

- Use manual complete button for bundle testing
- Expect bundle codes without webhook
- Test without Stripe CLI running

---

## Related Files

- `backend/src/controllers/webhookController.ts` (lines 202-243) - Bundle generation
- `frontend/src/pages/PurchaseSuccess.tsx` - Bundle code display
- `frontend/src/components/promo/BundlePromoCodeCard.tsx` - UI component
- `backend/src/models/SystemConfig.ts` - Config management
- `docs/BUG_FIX_CLASS_REP_MISSING_COUNT.md` - Related bug fixes
