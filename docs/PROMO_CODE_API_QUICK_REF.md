# Promo Code API - Developer Quick Reference

**Last Updated**: 2025-10-18  
**Base URL**: `/api/promo-codes`

---

## Authentication

All endpoints require authentication via JWT token:

```bash
Authorization: Bearer {your-jwt-token}
```

Admin endpoints additionally require administrator role.

---

## User Endpoints

### Get My Promo Codes

```http
GET /api/promo-codes/my-codes?status={filter}
```

**Query Parameters**:

- `status`: `all` | `active` | `expired` | `used` (default: `all`)

**Response**:

```json
{
  "success": true,
  "codes": [
    {
      "_id": "...",
      "code": "BUNDLE50",
      "type": "bundle_discount",
      "discountAmount": 5000,
      "isValid": true,
      "expiresAt": "2025-11-18T00:00:00Z"
    }
  ]
}
```

---

### Validate Promo Code

```http
POST /api/promo-codes/validate
Content-Type: application/json
```

**Request Body**:

```json
{
  "code": "BUNDLE50",
  "programId": "60d5ec49f1b2c72b8c8e4f1a"
}
```

**Response (Valid)**:

```json
{
  "success": true,
  "valid": true,
  "message": "Promo code is valid.",
  "code": {
    "type": "bundle_discount",
    "discountAmount": 5000
  }
}
```

**Response (Invalid)**:

```json
{
  "success": true,
  "valid": false,
  "message": "This promo code has expired."
}
```

---

## Admin Endpoints

### List All Promo Codes

```http
GET /api/promo-codes?type={type}&status={status}&search={query}&page={n}&limit={n}
```

**Query Parameters**:

- `type`: `all` | `bundle_discount` | `staff_access`
- `status`: `all` | `active` | `expired` | `used`
- `search`: Search by code or owner name/email
- `page`: Page number (default: 1)
- `limit`: Results per page (default: 20, max: 100)

**Response**:

```json
{
  "success": true,
  "codes": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 45,
    "pages": 3
  }
}
```

---

### Create Staff Access Code

```http
POST /api/promo-codes/staff
Content-Type: application/json
```

**Request Body**:

```json
{
  "userId": "60d5ec49f1b2c72b8c8e4f1a",
  "discountPercent": 100,
  "allowedProgramIds": ["..."],
  "expiresAt": "2025-12-31T23:59:59Z"
}
```

**Validation**:

- `userId`: Required, must exist
- `discountPercent`: Required, 0-100
- `allowedProgramIds`: Optional (empty = all programs)
- `expiresAt`: Optional (must be future date)

**Response**:

```json
{
  "success": true,
  "message": "Staff promo code created successfully.",
  "code": {
    "_id": "...",
    "code": "ABC12XYZ",
    "type": "staff_access",
    "discountPercent": 100,
    "ownerId": {...},
    "createdAt": "2025-10-18T10:30:00Z"
  }
}
```

---

### Get Bundle Config

```http
GET /api/promo-codes/config
```

**Response**:

```json
{
  "success": true,
  "config": {
    "enabled": true,
    "discountAmount": 5000,
    "expiryDays": 30
  }
}
```

---

### Update Bundle Config

```http
PUT /api/promo-codes/config
Content-Type: application/json
```

**Request Body**:

```json
{
  "enabled": true,
  "discountAmount": 7500,
  "expiryDays": 60
}
```

**⚠️ Status**: 501 Not Implemented (requires Todo #17)

---

### Deactivate Promo Code

```http
PUT /api/promo-codes/:id/deactivate
```

**Response**:

```json
{
  "success": true,
  "message": "Promo code deactivated successfully.",
  "code": {
    "_id": "...",
    "code": "BUNDLE50",
    "isActive": false
  }
}
```

---

## Error Responses

### 400 Bad Request

```json
{
  "success": false,
  "message": "Invalid program ID."
}
```

### 401 Unauthorized

```json
{
  "success": false,
  "message": "Authentication required."
}
```

### 403 Forbidden

```json
{
  "success": false,
  "message": "Administrator access required."
}
```

### 404 Not Found

```json
{
  "success": false,
  "message": "Promo code not found."
}
```

### 500 Server Error

```json
{
  "success": false,
  "message": "Failed to fetch promo codes."
}
```

### 501 Not Implemented

```json
{
  "success": false,
  "message": "Bundle config update not yet implemented..."
}
```

---

## Code Types

### Bundle Discount

- **Generated by**: Webhook after purchase
- **Discount**: Fixed dollar amount (e.g., $50 off)
- **Restrictions**: Cannot use on excluded program (the one purchased)
- **Ownership**: User-specific

### Staff Access

- **Created by**: Admin
- **Discount**: Percentage (0-100%)
- **Restrictions**: Can specify allowed programs
- **Ownership**: Assigned to specific user

---

## Testing

### Manual Test

```bash
# 1. Export your JWT token
export TOKEN="eyJhbGc..."

# 2. Test user endpoint
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:5001/api/promo-codes/my-codes

# 3. Validate a code
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"code":"BUNDLE50","programId":"..."}' \
  http://localhost:5001/api/promo-codes/validate
```

### Using Test Script

```bash
cd backend
export TOKEN="your-token"
./test-promo-api.sh
```

---

## Common Use Cases

### 1. User Views Their Codes

```
GET /my-codes?status=active
→ Shows all valid codes ready to use
```

### 2. User Applies Code at Checkout

```
POST /validate {"code":"BUNDLE50","programId":"..."}
→ Frontend checks if valid before checkout
→ Checkout API applies discount
```

### 3. Admin Creates 100% Staff Code

```
POST /staff {
  "userId": "...",
  "discountPercent": 100,
  "allowedProgramIds": []
}
→ Code works for all programs
→ User can purchase for free
```

### 4. Admin Searches for User's Codes

```
GET /?search=john@example.com
→ Finds all codes for that user
```

### 5. Admin Disables Compromised Code

```
PUT /:id/deactivate
→ Code becomes invalid immediately
```

---

## Environment Variables

```bash
# Bundle Discount Configuration (Temporary - Todo #17)
BUNDLE_DISCOUNT_ENABLED=true
BUNDLE_DISCOUNT_AMOUNT=5000  # $50.00
BUNDLE_EXPIRY_DAYS=30
```

**Note**: These will be database-configured in Todo #17.

---

## Security Notes

### Authentication

- All routes check JWT token validity
- Token must not be expired
- User must exist in database

### Authorization

- Admin routes verify user role
- Bundle codes verify ownership
- Staff codes verify program restrictions

### Input Validation

- All IDs validated as MongoDB ObjectIds
- Numeric values checked for ranges
- Dates validated for future values
- Strings sanitized for queries

### Single Use

- Codes marked as used after purchase
- Cannot reuse even if deactivated
- Used codes still queryable for history

---

## Performance Tips

### User Queries

- Use `status` filter to reduce results
- Codes are indexed on `ownerId + isActive + isUsed`

### Admin Queries

- Use pagination (`limit=20`)
- Use specific filters before search
- Search uses regex (slower on large datasets)

### Validation

- Fast code lookup via unique index
- Program checks use compound indexes
- Ownership check is O(1) comparison

---

## Troubleshooting

### "Authentication required"

- Check token is in Authorization header
- Verify token not expired
- Ensure user still exists

### "Administrator access required"

- Only admins can access admin routes
- Check user role in database

### "Invalid promo code"

- Code might not exist
- Check spelling (codes are uppercase)
- Code might be deactivated

### "This promo code has expired"

- Check `expiresAt` field
- Bundle codes expire after X days (config)

### "This bundle code belongs to another user"

- Bundle codes are user-specific
- Only owner can use their bundle code
- Staff codes don't have ownership check

---

## Integration Checklist

### Frontend Integration

- [ ] Update PromoCodeService with API calls
- [ ] Add error handling for all endpoints
- [ ] Show loading states during validation
- [ ] Display detailed error messages to users
- [ ] Cache user's codes to reduce API calls
- [ ] Invalidate cache after code used

### Testing Integration

- [ ] Test all 7 endpoints
- [ ] Test authorization (user vs admin)
- [ ] Test validation edge cases
- [ ] Test pagination
- [ ] Test search functionality
- [ ] Test with expired codes
- [ ] Test with used codes
- [ ] Test program restrictions

---

## Related Documentation

- `PROMO_CODE_UI_SPECS.md` - Original design specifications
- `TODO_16_PROMO_CODE_API_COMPLETE.md` - Detailed implementation docs
- `PROMO_CODE_PHASE2_BACKEND_COMPLETE.md` - Backend completion summary

---

**Questions?** Check the detailed documentation or contact the backend team.
