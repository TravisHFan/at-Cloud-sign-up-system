# ✅ Todo #13 Complete: Update Purchase Model with Promo Fields

**Status**: ✅ COMPLETE  
**Completed**: 2025-10-18  
**File**: `backend/src/models/Purchase.ts`

---

## What Was Done

Updated the Purchase model to support promo code tracking by adding 6 new optional fields that track both:

1. **Promo codes USED on purchases** (customer applied a code to get a discount)
2. **Promo codes GENERATED by purchases** (system creates bundle codes after purchases)

---

## Fields Added

### A. Promo Code USED on Purchase (3 fields)

These fields track when a customer applies a promo code during checkout:

#### 1. `promoCode?: string`

- **Purpose**: Store the exact promo code that was applied to this purchase
- **Type**: Optional string, max 20 characters
- **Index**: Added index for efficient searching by promo code
- **Example**: `"X8K9P2L4"` or `"STAFF2025"`

#### 2. `promoDiscountAmount?: number`

- **Purpose**: Track dollar discount applied (for bundle discount codes)
- **Type**: Optional number (in cents)
- **Validation**: 0-100000 cents ($0-$1000)
- **Example**: `5000` (represents $50.00 off)
- **Used When**: Bundle discount codes provide fixed dollar amounts

#### 3. `promoDiscountPercent?: number`

- **Purpose**: Track percentage discount applied (for staff access codes)
- **Type**: Optional number
- **Validation**: 0-100 (percentage)
- **Example**: `100` (represents 100% off - free purchase)
- **Used When**: Staff codes provide percentage discounts (typically 100%)

### B. Bundle Promo Code GENERATED by Purchase (3 fields)

These fields track when the system generates a new bundle code for a customer after they complete a purchase:

#### 4. `bundlePromoCode?: string`

- **Purpose**: Store the bundle code that was generated for this purchase
- **Type**: Optional string, max 20 characters
- **Example**: `"B7M3N9R5"` (auto-generated 8-character code)
- **When Set**: After successful payment, webhook creates new PromoCode and stores code here

#### 5. `bundleDiscountAmount?: number`

- **Purpose**: Track the discount amount the bundle code provides
- **Type**: Optional number (in cents)
- **Validation**: 0-100000 cents ($0-$1000)
- **Example**: `5000` (bundle code gives $50.00 off next purchase)
- **Configuration**: Comes from system config (default $50)

#### 6. `bundleExpiresAt?: Date`

- **Purpose**: Track when the generated bundle code expires
- **Type**: Optional Date
- **Example**: `new Date('2025-11-18')` (30 days from creation)
- **Configuration**: Comes from system config (default 30 days)

---

## Schema Implementation

### IPurchase Interface Update

```typescript
export interface IPurchase extends Document {
  // ... existing fields ...

  // Promo code fields - code USED on this purchase
  promoCode?: string;
  promoDiscountAmount?: number;
  promoDiscountPercent?: number;

  // Bundle promo fields - code GENERATED by this purchase
  bundlePromoCode?: string;
  bundleDiscountAmount?: number;
  bundleExpiresAt?: Date;

  // ... rest of interface ...
}
```

### Mongoose Schema Update

```typescript
const purchaseSchema = new Schema<IPurchase>({
  // ... existing fields ...

  // Promo code fields - code USED on this purchase
  promoCode: {
    type: String,
    trim: true,
    maxlength: 20,
    index: true, // Index for searching by promo code
  },
  promoDiscountAmount: {
    type: Number,
    min: 0,
    max: 100000, // 0-100000 cents ($0-$1000)
  },
  promoDiscountPercent: {
    type: Number,
    min: 0,
    max: 100, // 0-100%
  },

  // Bundle promo fields - code GENERATED by this purchase
  bundlePromoCode: {
    type: String,
    trim: true,
    maxlength: 20,
  },
  bundleDiscountAmount: {
    type: Number,
    min: 0,
    max: 100000, // 0-100000 cents ($0-$1000)
  },
  bundleExpiresAt: {
    type: Date,
  },

  // ... rest of schema ...
});
```

---

## Key Design Decisions

### 1. All Fields Optional

All 6 fields are optional because:

- Not all purchases will use promo codes
- Not all purchases will generate bundle codes
- Backwards compatibility with existing purchases
- Allows system to disable bundle feature without schema changes

### 2. Index on `promoCode`

Added database index for efficient queries:

- Admin searches for all purchases using a specific code
- Analytics queries: "How many times was code X used?"
- Fraud detection: Check if code used multiple times by same user

### 3. Separate Amount vs Percent Fields

Why two discount fields instead of one?

- **Bundle codes**: Fixed dollar amount (e.g., $50 off)
- **Staff codes**: Percentage discount (typically 100% off)
- Easier to display in UI ("$50 off" vs "100% off")
- Simpler calculation logic in checkout

### 4. Storing Bundle Code Details

Why store `bundleDiscountAmount` and `bundleExpiresAt` in Purchase?

- **Audit trail**: Know what the code was worth when generated
- **Historical data**: Even if admin changes config, we know original values
- **Purchase history display**: Show "You received $50 off code" in order details
- **Customer service**: Quickly see bundle code details without querying PromoCode collection

---

## Usage Examples

### Example 1: User Applies Bundle Discount Code

```typescript
// User applying $50 bundle code during checkout
const purchase = await Purchase.create({
  userId: user._id,
  programId: program._id,
  orderNumber: await Purchase.generateOrderNumber(),
  fullPrice: 50000, // $500 program
  classRepDiscount: 0,
  earlyBirdDiscount: 0,
  // Apply bundle code
  promoCode: "X8K9P2L4",
  promoDiscountAmount: 5000, // $50 off
  promoDiscountPercent: undefined, // Not a percentage code
  finalPrice: 45000, // $500 - $50 = $450
  isClassRep: false,
  isEarlyBird: false,
  billingInfo: {...},
  paymentMethod: {...},
  status: "pending"
});
```

### Example 2: User Applies 100% Staff Code

```typescript
// User applying 100% off staff code
const purchase = await Purchase.create({
  userId: user._id,
  programId: program._id,
  orderNumber: await Purchase.generateOrderNumber(),
  fullPrice: 50000, // $500 program
  classRepDiscount: 0,
  earlyBirdDiscount: 0,
  // Apply staff code
  promoCode: "STAFF2025",
  promoDiscountAmount: undefined, // Not a fixed amount
  promoDiscountPercent: 100, // 100% off
  finalPrice: 0, // Free!
  isClassRep: false,
  isEarlyBird: false,
  billingInfo: {...},
  paymentMethod: {...},
  status: "completed", // No Stripe needed, complete immediately
  purchaseDate: new Date()
});
```

### Example 3: Webhook Generates Bundle Code

```typescript
// After payment success, webhook updates purchase with generated code
await purchase.updateOne({
  $set: {
    status: "completed",
    bundlePromoCode: "B7M3N9R5", // Generated code
    bundleDiscountAmount: 5000, // $50 off
    bundleExpiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days
  },
});
```

### Example 4: Query Purchases by Promo Code

```typescript
// Admin analytics: Find all purchases using specific code
const purchases = await Purchase.find({ promoCode: "X8K9P2L4" })
  .populate("userId", "firstName lastName email")
  .populate("programId", "title")
  .sort({ purchaseDate: -1 });

console.log(`Code used ${purchases.length} times`);
```

---

## Integration with PromoCode Model

### Relationship Flow

```
┌─────────────────┐         ┌─────────────────┐
│   PromoCode     │         │    Purchase     │
│  (Todo #12)     │         │   (Todo #13)    │
├─────────────────┤         ├─────────────────┤
│ code: "X8K9P2L4"│◄────────┤ promoCode       │ // Reference (string)
│ type: "bundle"  │         │ promoDiscount.. │
│ discountAmount  │         │                 │
│ isUsed: false   │         ├─────────────────┤
└─────────────────┘         │ bundlePromoCode │──┐
                            │ bundleDiscount..│  │ // Generated
                            └─────────────────┘  │
                                                 │
                                                 ▼
                            ┌─────────────────┐
                            │   PromoCode     │
                            │  (NEW RECORD)   │
                            ├─────────────────┤
                            │ code: "B7M3N9R5"│
                            │ type: "bundle"  │
                            │ ownerId: userId │
                            │ excludedProgram │
                            └─────────────────┘
```

### Data Consistency

1. **When code applied**:

   - Purchase stores `promoCode` string
   - PromoCode document marked `isUsed: true`
   - Purchase discount fields populated

2. **When bundle generated**:

   - New PromoCode document created
   - Purchase stores `bundlePromoCode` string
   - Purchase stores bundle details for audit trail

3. **No direct ObjectId reference**:
   - Purchase uses string codes, not ObjectId refs
   - Simpler queries, no populate needed
   - PromoCode can be deleted without breaking Purchase history

---

## Validation & Constraints

### Field Constraints

| Field                | Required    | Type   | Min | Max      | Index  |
| -------------------- | ----------- | ------ | --- | -------- | ------ |
| promoCode            | ❌ Optional | String | -   | 20 chars | ✅ Yes |
| promoDiscountAmount  | ❌ Optional | Number | 0   | 100000   | ❌ No  |
| promoDiscountPercent | ❌ Optional | Number | 0   | 100      | ❌ No  |
| bundlePromoCode      | ❌ Optional | String | -   | 20 chars | ❌ No  |
| bundleDiscountAmount | ❌ Optional | Number | 0   | 100000   | ❌ No  |
| bundleExpiresAt      | ❌ Optional | Date   | -   | -        | ❌ No  |

### Business Logic Validation (to be implemented in Todo #14)

When a promo code is applied during checkout:

- [ ] Code must exist in PromoCode collection
- [ ] Code must be active (`isActive: true`)
- [ ] Code must not be used (`isUsed: false`)
- [ ] Code must not be expired (`expiresAt > now`)
- [ ] Code must belong to user (`ownerId === userId`)
- [ ] For bundle codes: `excludedProgramId !== programId`
- [ ] For staff codes: `allowedProgramIds` empty or includes `programId`

---

## Impact on Existing Code

### Files Modified

1. ✅ `backend/src/models/Purchase.ts` - Added 6 fields to interface and schema

### Files NOT Modified (intentional)

- Purchase controller (Todo #14 will update checkout logic)
- Webhook handler (Todo #15 will add bundle generation)
- Purchase routes (no route changes needed)
- Purchase tests (Todo #22 will add tests)

### Backwards Compatibility

- ✅ All new fields optional - existing purchases unaffected
- ✅ No breaking changes to existing queries
- ✅ Existing purchase creation still works (fields default to undefined)
- ✅ No migration script needed

---

## Next Steps - Todo #14

Now that Purchase model is updated, Todo #14 will enhance the checkout API to:

1. **Accept promo code parameter**:

   ```typescript
   POST /api/purchases/create-checkout-session
   Body: {
     programId: "...",
     isClassRep: false,
     billingInfo: {...},
     promoCode: "X8K9P2L4" // NEW PARAMETER
   }
   ```

2. **Validate promo code**:

   ```typescript
   // Use PromoCode.canBeUsedForProgram() from Todo #12
   const promoCode = await PromoCode.findOne({ code: req.body.promoCode });
   const validation = promoCode.canBeUsedForProgram(programId);
   if (!validation.valid) {
     return res.status(400).json({ error: validation.reason });
   }
   ```

3. **Calculate discount**:

   ```typescript
   let finalPrice = basePrice;
   let promoDiscountAmount, promoDiscountPercent;

   if (promoCode.type === "bundle_discount") {
     promoDiscountAmount = promoCode.discountAmount;
     finalPrice -= promoCode.discountAmount;
   } else if (promoCode.type === "staff_access") {
     promoDiscountPercent = promoCode.discountPercent;
     finalPrice = finalPrice * (1 - promoCode.discountPercent / 100);
   }
   ```

4. **Handle 100% off (no Stripe)**:

   ```typescript
   if (finalPrice === 0) {
     // Skip Stripe, create completed purchase immediately
     const purchase = await Purchase.create({
       ...purchaseData,
       promoCode: req.body.promoCode,
       promoDiscountPercent: 100,
       finalPrice: 0,
       status: "completed",
     });
     await promoCode.markAsUsed(programId);
     return res.json({ success: true, orderId: purchase.orderNumber });
   }
   ```

5. **Store promo info**:
   ```typescript
   const purchase = await Purchase.create({
     ...purchaseData,
     promoCode: req.body.promoCode,
     promoDiscountAmount,
     promoDiscountPercent,
     finalPrice,
   });
   ```

---

## Success Criteria ✅

- [x] Added 6 promo fields to IPurchase interface
- [x] Added 6 promo fields to purchaseSchema
- [x] All fields properly typed (string, number, Date)
- [x] All fields optional (not required)
- [x] Added validation constraints (maxlength, min/max)
- [x] Added index on `promoCode` field
- [x] TypeScript compilation passes with no errors
- [x] Backwards compatible with existing purchases
- [x] No breaking changes to existing code

---

## Statistics

- **Files Modified**: 1 (`backend/src/models/Purchase.ts`)
- **Lines Added**: ~40 lines (interface + schema fields)
- **Fields Added**: 6 (3 for used codes, 3 for generated codes)
- **Indexes Added**: 1 (on `promoCode`)
- **Breaking Changes**: 0 (all fields optional)
- **Time Taken**: ~30 minutes

---

**Ready for Todo #14**: ✅ Enhance createCheckoutSession API to accept and validate promo codes!
