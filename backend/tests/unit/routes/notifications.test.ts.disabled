import { describe, it, expect, vi, beforeEach, afterEach } from "vitest";
import request from "supertest";
import express from "express";

// Mock ALL dependencies BEFORE importing the route
// This prevents any heavy initialization during import

// Mock the controllers FIRST - before any imports
vi.mock("../../../src/controllers/unifiedMessageController", () => ({
  UnifiedMessageController: {
    getSystemMessages: vi.fn((req, res) =>
      res.status(200).json({ messages: [] })
    ),
    markAsRead: vi.fn((req, res) => res.status(200).json({ success: true })),
    createSystemMessage: vi.fn((req, res) =>
      res.status(201).json({ id: "msg-123" })
    ),
    deleteMessage: vi.fn((req, res) => res.status(204).send()),
    getBellNotifications: vi.fn((req, res) =>
      res.status(200).json({ notifications: [] })
    ),
    markBellNotificationAsRead: vi.fn((req, res) =>
      res.status(200).json({ success: true })
    ),
    markAllBellNotificationsAsRead: vi.fn((req, res) =>
      res.status(200).json({ success: true })
    ),
    removeBellNotification: vi.fn((req, res) => res.status(204).send()),
    getUnreadCounts: vi.fn((req, res) =>
      res.status(200).json({ system: 5, bell: 3 })
    ),
    cleanupExpiredMessages: vi.fn((req, res) =>
      res.status(200).json({ cleaned: 10 })
    ),
    checkWelcomeMessageStatus: vi.fn((req, res) =>
      res.status(200).json({ received: false })
    ),
    sendWelcomeNotification: vi.fn((req, res) =>
      res.status(200).json({ sent: true })
    ),
  },
}));

vi.mock("../../../src/controllers/emailNotificationController", () => ({
  EmailNotificationController: {
    sendEventCreatedNotification: vi.fn((req, res) =>
      res.status(200).json({ sent: true })
    ),
    sendSystemAuthorizationChangeNotification: vi.fn((req, res) =>
      res.status(200).json({ sent: true })
    ),
    sendCoOrganizerAssignedNotification: vi.fn((req, res) =>
      res.status(200).json({ sent: true })
    ),
  },
}));

// Mock authentication middleware
vi.mock("../../../src/middleware/auth", () => ({
  authenticate: vi.fn((req, res, next) => {
    req.user = { id: "user-123", role: "USER" };
    next();
  }),
}));

// Mock validation middleware
vi.mock("../../../src/middleware/validation", () => ({
  validateSystemMessage: vi.fn((req, res, next) => next()),
  validateError: vi.fn((req, res, next) => next()),
  handleValidationErrors: vi.fn((req, res, next) => next()),
}));

// Mock express-validator
vi.mock("express-validator", () => {
  const mockValidationChain = () => {
    const chain = vi.fn((req, res, next) => next()) as any;
    chain.notEmpty = vi.fn(() => chain);
    chain.withMessage = vi.fn(() => chain);
    chain.isString = vi.fn(() => chain);
    return chain;
  };

  return {
    param: vi.fn(() => mockValidationChain()),
    body: vi.fn(() => mockValidationChain()),
    validationResult: vi.fn(() => ({
      isEmpty: vi.fn(() => true),
      array: vi.fn(() => []),
    })),
  };
});

// Mock database models
vi.mock("../../../src/models", () => ({
  User: {
    findById: vi.fn().mockResolvedValue(null),
    find: vi.fn().mockResolvedValue([]),
  },
  Message: {
    find: vi.fn().mockResolvedValue([]),
    findById: vi.fn().mockResolvedValue(null),
    create: vi.fn().mockResolvedValue({ id: "msg-123" }),
  },
}));

// Mock SocketService to prevent hanging
vi.mock("../../../src/services/infrastructure/SocketService", () => ({
  socketService: {
    emitToUser: vi.fn().mockImplementation(() => Promise.resolve(true)),
    emitToUserSockets: vi.fn().mockImplementation(() => Promise.resolve(true)),
    emitSystemUpdate: vi.fn().mockImplementation(() => Promise.resolve(true)),
    isConnected: vi.fn().mockReturnValue(true),
    // Add cleanup methods
    disconnect: vi.fn().mockImplementation(() => Promise.resolve()),
    close: vi.fn().mockImplementation(() => Promise.resolve()),
  },
}));

// Mock TrioNotificationService to prevent real notifications
vi.mock("../../../src/services/notifications/TrioNotificationService", () => ({
  trioNotificationService: {
    sendTrioNotification: vi.fn().mockImplementation(() => 
      Promise.resolve({ success: true })
    ),
    // Add cleanup methods
    cleanup: vi.fn().mockImplementation(() => Promise.resolve()),
  },
}));

// Mock any MongoDB connections
vi.mock("mongoose", () => ({
  connect: vi.fn().mockResolvedValue({}),
  disconnect: vi.fn().mockResolvedValue({}),
  connection: {
    readyState: 1,
    close: vi.fn().mockResolvedValue({}),
  },
}));

// NOW import the route - after all mocks are set up
import notificationsRoutes from "../../../src/routes/notifications";

describe("Notifications Routes", () => {
  let app: express.Application;

  beforeEach(async () => {
    // Clear all mocks before each test
    vi.clearAllMocks();
    vi.resetAllMocks();
    
    // Create a fresh Express app for each test
    app = express();
    app.use(express.json());
    app.use("/api/v1/notifications", notificationsRoutes);
    
    // Wait a tick to ensure all async operations are settled
    await new Promise(resolve => setImmediate(resolve));
  });

  afterEach(async () => {
    // Clean up any pending operations
    vi.clearAllMocks();
    vi.resetAllMocks();
    
    // Wait for any pending async operations to complete
    await new Promise(resolve => setImmediate(resolve));
  });

  describe("Route Existence", () => {
    // Test each route individually with proper cleanup
    it("should have system messages GET route", async () => {
      const response = await request(app)
        .get("/api/v1/notifications/system")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have system message mark as read PATCH route", async () => {
      const response = await request(app)
        .patch("/api/v1/notifications/system/msg-123/read")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have system message create POST route", async () => {
      const response = await request(app)
        .post("/api/v1/notifications/system")
        .send({ type: "info", content: "Test message" })
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have system message delete DELETE route", async () => {
      const response = await request(app)
        .delete("/api/v1/notifications/system/msg-123")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have bell notifications GET route", async () => {
      const response = await request(app)
        .get("/api/v1/notifications/bell")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have bell notification mark as read PATCH route", async () => {
      const response = await request(app)
        .patch("/api/v1/notifications/bell/notif-123/read")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have bell notifications mark all read PATCH route", async () => {
      const response = await request(app)
        .patch("/api/v1/notifications/bell/read-all")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have bell notification remove DELETE route", async () => {
      const response = await request(app)
        .delete("/api/v1/notifications/bell/notif-123")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have email event-created POST route", async () => {
      const response = await request(app)
        .post("/api/v1/notifications/email/event-created")
        .send({ eventId: "event-123" })
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have email role-change POST route", async () => {
      const response = await request(app)
        .post("/api/v1/notifications/email/role-change")
        .send({ userId: "user-123", newRole: "ADMIN" })
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have email co-organizer-assigned POST route", async () => {
      const response = await request(app)
        .post("/api/v1/notifications/email/co-organizer-assigned")
        .send({ eventId: "event-123", userId: "user-123" })
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have unread counts GET route", async () => {
      const response = await request(app)
        .get("/api/v1/notifications/unread-counts")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have cleanup POST route", async () => {
      const response = await request(app)
        .post("/api/v1/notifications/cleanup")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have welcome status GET route", async () => {
      const response = await request(app)
        .get("/api/v1/notifications/welcome-status")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);

    it("should have welcome POST route", async () => {
      const response = await request(app)
        .post("/api/v1/notifications/welcome")
        .timeout(2000);

      expect(response.status).not.toBe(404);
    }, 5000);
  });

  describe("System Messages", () => {
    describe("GET /system", () => {
      it("should get system messages successfully", async () => {
        const response = await request(app)
          .get("/api/v1/notifications/system")
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ messages: [] });
      }, 5000);

      it("should support query parameters", async () => {
        const response = await request(app)
          .get("/api/v1/notifications/system?type=info&isRead=false&page=1&limit=10")
          .timeout(2000);

        expect(response.status).toBe(200);
      }, 5000);
    });

    describe("PATCH /system/:messageId/read", () => {
      it("should mark system message as read successfully", async () => {
        const response = await request(app)
          .patch("/api/v1/notifications/system/msg-123/read")
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ success: true });
      }, 5000);

      it("should handle different message IDs", async () => {
        const response = await request(app)
          .patch("/api/v1/notifications/system/msg-456/read")
          .timeout(2000);

        expect(response.status).toBe(200);
      }, 5000);
    });

    describe("POST /system", () => {
      it("should create system message successfully", async () => {
        const messageData = {
          type: "info",
          content: "Test system message",
          priority: "normal",
        };

        const response = await request(app)
          .post("/api/v1/notifications/system")
          .send(messageData)
          .timeout(2000);

        expect(response.status).toBe(201);
        expect(response.body).toEqual({ id: "msg-123" });
      }, 5000);

      it("should handle different message types", async () => {
        const messageData = {
          type: "warning",
          content: "Test warning message",
          priority: "high",
        };

        const response = await request(app)
          .post("/api/v1/notifications/system")
          .send(messageData)
          .timeout(2000);

        expect(response.status).toBe(201);
      }, 5000);
    });

    describe("DELETE /system/:messageId", () => {
      it("should delete system message successfully", async () => {
        const response = await request(app)
          .delete("/api/v1/notifications/system/msg-123")
          .timeout(2000);

        expect(response.status).toBe(204);
      }, 5000);

      it("should handle different message IDs", async () => {
        const response = await request(app)
          .delete("/api/v1/notifications/system/msg-789")
          .timeout(2000);

        expect(response.status).toBe(204);
      }, 5000);
    });
  });

  describe("Bell Notifications", () => {
    describe("GET /bell", () => {
      it("should get bell notifications successfully", async () => {
        const response = await request(app)
          .get("/api/v1/notifications/bell")
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ notifications: [] });
      }, 5000);
    });

    describe("PATCH /bell/:messageId/read", () => {
      it("should mark bell notification as read successfully", async () => {
        const response = await request(app)
          .patch("/api/v1/notifications/bell/notif-123/read")
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ success: true });
      }, 5000);
    });

    describe("PATCH /bell/read-all", () => {
      it("should mark all bell notifications as read successfully", async () => {
        const response = await request(app)
          .patch("/api/v1/notifications/bell/read-all")
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ success: true });
      }, 5000);
    });

    describe("DELETE /bell/:messageId", () => {
      it("should remove bell notification successfully", async () => {
        const response = await request(app)
          .delete("/api/v1/notifications/bell/notif-123")
          .timeout(2000);

        expect(response.status).toBe(204);
      }, 5000);
    });
  });

  describe("Email Notifications", () => {
    describe("POST /email/event-created", () => {
      it("should send event created notification successfully", async () => {
        const response = await request(app)
          .post("/api/v1/notifications/email/event-created")
          .send({ eventId: "event-123" })
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ sent: true });
      }, 5000);
    });

    describe("POST /email/role-change", () => {
      it("should send role change notification successfully", async () => {
        const response = await request(app)
          .post("/api/v1/notifications/email/role-change")
          .send({ userId: "user-123", newRole: "ADMIN" })
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ sent: true });
      }, 5000);
    });

    describe("POST /email/co-organizer-assigned", () => {
      it("should send co-organizer assigned notification successfully", async () => {
        const response = await request(app)
          .post("/api/v1/notifications/email/co-organizer-assigned")
          .send({ eventId: "event-123", userId: "user-123" })
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ sent: true });
      }, 5000);
    });
  });

  describe("Utility Endpoints", () => {
    describe("GET /unread-counts", () => {
      it("should get unread counts successfully", async () => {
        const response = await request(app)
          .get("/api/v1/notifications/unread-counts")
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ system: 5, bell: 3 });
      }, 5000);
    });

    describe("POST /cleanup", () => {
      it("should cleanup expired messages successfully", async () => {
        const response = await request(app)
          .post("/api/v1/notifications/cleanup")
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ cleaned: 10 });
      }, 5000);
    });
  });

  describe("Welcome System", () => {
    describe("GET /welcome-status", () => {
      it("should check welcome message status successfully", async () => {
        const response = await request(app)
          .get("/api/v1/notifications/welcome-status")
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ received: false });
      }, 5000);
    });

    describe("POST /welcome", () => {
      it("should send welcome notification successfully", async () => {
        const response = await request(app)
          .post("/api/v1/notifications/welcome")
          .timeout(2000);

        expect(response.status).toBe(200);
        expect(response.body).toEqual({ sent: true });
      }, 5000);
    });
  });

  describe("Authentication Integration", () => {
    it("should require authentication for all routes", async () => {
      // This test verifies that authentication middleware is applied
      // The mocked authenticate middleware sets req.user
      const response = await request(app)
        .get("/api/v1/notifications/system")
        .timeout(2000);

      expect(response.status).toBe(200);
      // Authentication is mocked to always succeed in tests
    }, 5000);

    it("should apply authentication to POST routes", async () => {
      const response = await request(app)
        .post("/api/v1/notifications/system")
        .send({ type: "info", content: "Test" })
        .timeout(2000);

      expect(response.status).toBe(201);
    }, 5000);

    it("should apply authentication to PATCH routes", async () => {
      const response = await request(app)
        .patch("/api/v1/notifications/system/msg-123/read")
        .timeout(2000);

      expect(response.status).toBe(200);
    }, 5000);

    it("should apply authentication to DELETE routes", async () => {
      const response = await request(app)
        .delete("/api/v1/notifications/system/msg-123")
        .timeout(2000);

      expect(response.status).toBe(204);
    }, 5000);
  });

  describe("Validation Integration", () => {
    it("should validate system message creation", async () => {
      const response = await request(app)
        .post("/api/v1/notifications/system")
        .send({ type: "info", content: "Valid message" })
        .timeout(2000);

      expect(response.status).toBe(201);
    }, 5000);

    it("should validate message ID parameters", async () => {
      const response = await request(app)
        .patch("/api/v1/notifications/system/valid-id/read")
        .timeout(2000);

      expect(response.status).toBe(200);
    }, 5000);
  });

  describe("Error Scenarios", () => {
    it("should handle invalid routes gracefully", async () => {
      const response = await request(app)
        .get("/api/v1/notifications/invalid-route")
        .timeout(2000);

      expect(response.status).toBe(404);
    }, 5000);

    it("should handle malformed requests", async () => {
      const response = await request(app)
        .post("/api/v1/notifications/system")
        .send("invalid json")
        .timeout(2000);

      // Express should handle malformed JSON
      expect([400, 201]).toContain(response.status);
    }, 5000);
  });
});
